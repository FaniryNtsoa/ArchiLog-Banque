<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Virement - Banque Premium</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body th:replace="~{base :: layout(~{::title}, ~{::section})}">
<section>
    <div class="page-content">
        <div class="container-sm">
            <div class="page-header">
                <h1 class="page-title">üîÅ Effectuer un Virement</h1>
                <p class="page-subtitle">Transf√©rez de l'argent entre vos comptes ou vers d'autres comptes</p>
            </div>

            <!-- Messages d'alerte -->
            <div th:if="${errorMessage}" class="alert alert-danger">
                <i class="alert__icon">‚ö†Ô∏è</i>
                <span th:text="${errorMessage}">Message d'erreur</span>
            </div>

            <div th:if="${successMessage}" class="alert alert-success">
                <i class="alert__icon">‚úÖ</i>
                <span th:text="${successMessage}">Message de succ√®s</span>
            </div>

            <div class="card">
                <div class="card__header">
                    <h2 class="card__title">Informations du virement</h2>
                </div>
                <div class="card__content">
                    <form method="POST" th:action="@{/virement}" class="form">
                        <div class="form-group">
                            <label for="numeroCompteDebiteur" class="form-label">
                                <i class="icon">üè¶</i>
                                Compte √† d√©biter *
                            </label>
                            <select id="numeroCompteDebiteur" 
                                    name="numeroCompteDebiteur" 
                                    class="form-input" 
                                    required
                                    onchange="updateSoldeDebiteur(this.value)">
                                <option value="">S√©lectionnez le compte √† d√©biter</option>
                                <option th:each="compte : ${comptes}" 
                                        th:value="${compte.numeroCompte}"
                                        th:selected="${numeroCompteDebiteur == compte.numeroCompte}"
                                        th:text="|${compte.libelleCompte} - ${compte.numeroCompte} (${#numbers.formatDecimal(compte.solde, 1, 'POINT', 0, 'COMMA')} Ar)|"
                                        th:data-solde="${compte.solde}"
                                        th:data-libelle="${compte.libelleCompte}">
                                    Compte
                                </option>
                            </select>
                            <small class="form-help">
                                Votre compte qui sera d√©bit√© du montant du virement
                            </small>
                            <div id="soldeDebiteurInfo" class="info-mini" style="display: none;">
                                <span id="soldeDebiteurText">Solde disponible : 0 Ar</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="numeroCompteCrediteur" class="form-label">
                                <i class="icon">üè¶</i>
                                Compte √† cr√©diter *
                            </label>
                            <input type="text" 
                                   id="numeroCompteCrediteur" 
                                   name="numeroCompteCrediteur" 
                                   class="form-input" 
                                   placeholder="Num√©ro du compte b√©n√©ficiaire"
                                   th:value="${numeroCompteCrediteur}"
                                   required
                                   maxlength="30">
                            <small class="form-help">
                                Le compte qui recevra le montant du virement
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="montant" class="form-label">
                                <i class="icon">üí∞</i>
                                Montant *
                            </label>
                            <input type="number" 
                                   id="montant" 
                                   name="montant" 
                                   class="form-input" 
                                   placeholder="0.00"
                                   th:value="${montant}"
                                   required
                                   min="0.01"
                                   step="0.01"
                                   oninput="updateMontantInfo(this.value)">
                            <small class="form-help">
                                Montant en Ariary (Ar)
                            </small>
                            <div id="montantInfo" class="info-mini" style="display: none;">
                                <span id="montantFormate">0 Ar</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="libelle" class="form-label">
                                <i class="icon">üìù</i>
                                Motif du virement
                            </label>
                            <input type="text" 
                                   id="libelle" 
                                   name="libelle" 
                                   class="form-input" 
                                   placeholder="Ex: Remboursement, Cadeau, Facture..."
                                   th:value="${libelle}"
                                   maxlength="255">
                            <small class="form-help">
                                Description optionnelle du virement
                            </small>
                        </div>

                        <!-- R√©sum√© du virement -->
                        <div class="info-box" id="resumeVirement" style="display: none;">
                            <div class="info-box__icon">üìã</div>
                            <div class="info-box__content">
                                <h4>R√©sum√© du virement</h4>
                                <div id="resumeDetails">
                                    <p><strong>De :</strong> <span id="resumeDebiteur">-</span></p>
                                    <p><strong>Vers :</strong> <span id="resumeCrediteur">-</span></p>
                                    <p><strong>Montant :</strong> <span id="resumeMontant">0 Ar</span></p>
                                    <p><strong>Solde apr√®s virement :</strong> <span id="resumeSoldeApres">-</span></p>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn--primary" id="submitBtn">
                                <i class="btn__icon">üí∏</i>
                                Effectuer le virement
                            </button>
                            <a th:href="@{/dashboard}" class="btn btn--secondary">
                                <i class="btn__icon">‚Ü©Ô∏è</i>
                                Retour au tableau de bord
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Conseils s√©curit√© -->
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-card__icon">üîí</div>
                    <h3>S√©curit√©</h3>
                    <p>V√©rifiez toujours le num√©ro de compte du b√©n√©ficiaire</p>
                </div>
                <div class="feature-card">
                    <div class="feature-card__icon">‚ö°</div>
                    <h3>Instantan√©</h3>
                    <p>Les virements sont trait√©s imm√©diatement</p>
                </div>
                <div class="feature-card">
                    <div class="feature-card__icon">üì±</div>
                    <h3>Suivi</h3>
                    <p>Consultez l'historique dans votre tableau de bord</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Script JavaScript pour l'interface dynamique -->
    <script>
        let soldeCompteDebiteur = 0;
        
        function updateSoldeDebiteur(numeroCompte) {
            const select = document.getElementById('numeroCompteDebiteur');
            const soldeInfo = document.getElementById('soldeDebiteurInfo');
            const soldeText = document.getElementById('soldeDebiteurText');
            
            if (!numeroCompte) {
                soldeInfo.style.display = 'none';
                soldeCompteDebiteur = 0;
                updateResumeVirement();
                return;
            }
            
            const selectedOption = select.querySelector(`option[value="${numeroCompte}"]`);
            if (!selectedOption) {
                soldeInfo.style.display = 'none';
                soldeCompteDebiteur = 0;
                updateResumeVirement();
                return;
            }
            
            const solde = parseFloat(selectedOption.dataset.solde) || 0;
            const libelle = selectedOption.dataset.libelle || '';
            soldeCompteDebiteur = solde;
            
            const formatNumber = (num) => {
                return new Intl.NumberFormat('fr-FR').format(num);
            };
            
            soldeText.textContent = `Solde disponible : ${formatNumber(solde)} Ar`;
            soldeInfo.style.display = 'block';
            
            updateResumeVirement();
        }
        
        function updateMontantInfo(montant) {
            const montantInfo = document.getElementById('montantInfo');
            const montantFormate = document.getElementById('montantFormate');
            
            if (!montant || montant <= 0) {
                montantInfo.style.display = 'none';
                updateResumeVirement();
                return;
            }
            
            const formatNumber = (num) => {
                return new Intl.NumberFormat('fr-FR').format(parseFloat(num));
            };
            
            montantFormate.textContent = `${formatNumber(montant)} Ar`;
            montantInfo.style.display = 'block';
            
            updateResumeVirement();
        }
        
        function updateResumeVirement() {
            const numeroCompteDebiteur = document.getElementById('numeroCompteDebiteur').value;
            const numeroCompteCrediteur = document.getElementById('numeroCompteCrediteur').value;
            const montant = parseFloat(document.getElementById('montant').value) || 0;
            
            const resumeBox = document.getElementById('resumeVirement');
            const resumeDebiteur = document.getElementById('resumeDebiteur');
            const resumeCrediteur = document.getElementById('resumeCrediteur');
            const resumeMontant = document.getElementById('resumeMontant');
            const resumeSoldeApres = document.getElementById('resumeSoldeApres');
            const submitBtn = document.getElementById('submitBtn');
            
            if (!numeroCompteDebiteur || !numeroCompteCrediteur || montant <= 0) {
                resumeBox.style.display = 'none';
                return;
            }
            
            const formatNumber = (num) => {
                return new Intl.NumberFormat('fr-FR').format(num);
            };
            
            const select = document.getElementById('numeroCompteDebiteur');
            const selectedOption = select.querySelector(`option[value="${numeroCompteDebiteur}"]`);
            const libelleDebiteur = selectedOption ? selectedOption.dataset.libelle : 'Compte inconnu';
            
            const soldeApres = soldeCompteDebiteur - montant;
            
            resumeDebiteur.textContent = `${libelleDebiteur} (${numeroCompteDebiteur})`;
            resumeCrediteur.textContent = numeroCompteCrediteur;
            resumeMontant.textContent = `${formatNumber(montant)} Ar`;
            resumeSoldeApres.textContent = `${formatNumber(soldeApres)} Ar`;
            
            // Changer la couleur si le solde devient n√©gatif
            if (soldeApres < 0) {
                resumeSoldeApres.style.color = '#dc3545';
                resumeSoldeApres.innerHTML += ' <small>(D√©couvert)</small>';
            } else {
                resumeSoldeApres.style.color = '#28a745';
            }
            
            resumeBox.style.display = 'block';
        }
        
        // √âv√©nements pour mettre √† jour le r√©sum√©
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('numeroCompteCrediteur').addEventListener('input', updateResumeVirement);
            
            // Initialiser l'affichage si des valeurs sont d√©j√† pr√©sentes
            const numeroCompteDebiteur = document.getElementById('numeroCompteDebiteur').value;
            const montant = document.getElementById('montant').value;
            
            if (numeroCompteDebiteur) {
                updateSoldeDebiteur(numeroCompteDebiteur);
            }
            if (montant) {
                updateMontantInfo(montant);
            }
            
            // Validation du formulaire
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                const numeroCompteDebiteur = document.getElementById('numeroCompteDebiteur').value;
                const numeroCompteCrediteur = document.getElementById('numeroCompteCrediteur').value;
                const montant = parseFloat(document.getElementById('montant').value) || 0;
                
                if (numeroCompteDebiteur === numeroCompteCrediteur) {
                    e.preventDefault();
                    alert('Les comptes d√©biteur et cr√©diteur doivent √™tre diff√©rents');
                    return;
                }
                
                if (montant <= 0) {
                    e.preventDefault();
                    alert('Le montant doit √™tre positif');
                    return;
                }
                
                // Demander confirmation pour les gros montants
                if (montant > 1000000) { // Plus d'1 million Ar
                    if (!confirm(`Confirmez-vous ce virement de ${new Intl.NumberFormat('fr-FR').format(montant)} Ar ?`)) {
                        e.preventDefault();
                        return;
                    }
                }
                
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.innerHTML = '‚è≥ Traitement en cours...';
                submitBtn.disabled = true;
            });
        });
    </script>
</section>
</body>
</html>