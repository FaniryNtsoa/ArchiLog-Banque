<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Effectuer un Retrait - Administration</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/admin-style.css}">
</head>
<body th:replace="~{base :: layout(~{::title}, ~{::section})}">
<section>
    <div class="page-content">
        <div class="container">

        <div class="page-header">
            <h1><i class="fas fa-arrow-up text-warning"></i> Effectuer un Retrait</h1>
            <div class="breadcrumb">
                <span th:text="${moduleName}">Situation Bancaire</span> / 
                <span>Opérations</span> /
                <span>Retrait</span>
            </div>
        </div>

        <!-- Messages d'alerte -->
        <div th:if="${errorMessage}" class="alert alert-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${errorMessage}">Message d'erreur</span>
        </div>

        <div th:if="${successMessage}" class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span th:text="${successMessage}">Message de succès</span>
        </div>

        <!-- Formulaire de retrait -->
        <div class="form-container">
            <form method="post" th:action="@{/admin/situation/retrait}" class="admin-form">
                <div class="form-section">
                    <h3><i class="fas fa-hand-holding-usd"></i> Informations du retrait</h3>
                    
                    <div class="form-group">
                        <label for="compteId">Compte débiteur *</label>
                        <select id="compteId" name="compteId" required onchange="updateSoldeInfo(this)">
                            <option value="">-- Sélectionnez un compte --</option>
                            <option th:each="compte : ${comptes}" 
                                    th:value="${compte.idCompte}" 
                                    th:data-solde="${compte.solde}"
                                    th:data-decouvert="${compte.decouvertAutorise ?: 0}"
                                    th:text="${compte.numeroCompte + ' - ' + compte.nomClient + ' ' + compte.prenomClient + ' (Solde: ' + compte.solde + ' XOF)'}">
                                CC123456789 - RAZAFY Jean (Solde: 150,000 XOF)
                            </option>
                        </select>
                        <div th:if="${!hasComptes}" class="form-help error">
                            <i class="fas fa-exclamation-triangle"></i>
                            Aucun compte disponible. Veuillez d'abord créer des comptes.
                        </div>
                        <div id="soldeInfo" class="form-help" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span id="soldeText">Solde actuel:</span>
                            <span id="decouvertText">Découvert autorisé:</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="montant">Montant à retirer (XOF) *</label>
                        <input type="number" 
                               id="montant" 
                               name="montant" 
                               required 
                               min="0.01" 
                               max="5000000"
                               step="0.01"
                               placeholder="0.00">
                        <div class="form-help">
                            <i class="fas fa-info-circle"></i>
                            Montant maximum autorisé : 5,000,000 XOF par transaction
                        </div>
                        <div id="montantWarning" class="form-help error" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="warningText">Le montant dépasse le solde disponible</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="motif">Motif du retrait</label>
                        <textarea id="motif" 
                                  name="motif" 
                                  rows="3"
                                  placeholder="Ex: Retrait d'espèces, paiement, etc."
                                  maxlength="255"></textarea>
                        <div class="form-help">
                            <i class="fas fa-info-circle"></i>
                            Optionnel - Précisez la nature ou la raison du retrait
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-warning" th:disabled="${!hasComptes}">
                        <i class="fas fa-check"></i> Effectuer le retrait
                    </button>
                    <a th:href="@{/admin/situation/comptes}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                </div>
            </form>
        </div>

        <!-- Raccourcis rapides -->
        <div class="quick-actions">
            <h4><i class="fas fa-bolt"></i> Actions rapides</h4>
            <div class="action-buttons">
                <a th:href="@{/admin/situation/depot}" class="btn btn-success">
                    <i class="fas fa-arrow-down"></i> Effectuer un dépôt
                </a>
                <a th:href="@{/admin/situation/virement}" class="btn btn-info">
                    <i class="fas fa-exchange-alt"></i> Effectuer un virement
                </a>
                <a th:href="@{/admin/situation/historique}" class="btn btn-secondary">
                    <i class="fas fa-history"></i> Consulter l'historique
                </a>
            </div>
        </div>

        <!-- Informations importantes -->
        <div class="info-box danger">
            <h4><i class="fas fa-exclamation-triangle"></i> Avertissements importants</h4>
            <ul>
                <li>Cette opération sera <strong>immédiatement définitive</strong></li>
                <li>Vérifiez que le solde est <strong>suffisant</strong> (avec découvert si autorisé)</li>
                <li>Les <strong>plafonds journaliers</strong> sont bypassés pour les admins</li>
                <li>L'opération sera <strong>tracée avec votre identifiant</strong> administrateur</li>
                <li><strong>Vérifiez l'identité</strong> du client avant validation</li>
                <li>Respectez les procédures de <strong>sécurité</strong> en vigueur</li>
            </ul>
        </div>
    </div>

    <script>
        let currentSolde = 0;
        let currentDecouvert = 0;

        function updateSoldeInfo(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const soldeInfo = document.getElementById('soldeInfo');
            
            if (selectedOption.value) {
                currentSolde = parseFloat(selectedOption.dataset.solde) || 0;
                currentDecouvert = parseFloat(selectedOption.dataset.decouvert) || 0;
                
                document.getElementById('soldeText').textContent = 
                    `Solde actuel: ${currentSolde.toLocaleString('fr-FR')} XOF`;
                document.getElementById('decouvertText').textContent = 
                    `Découvert autorisé: ${currentDecouvert.toLocaleString('fr-FR')} XOF`;
                
                soldeInfo.style.display = 'block';
                checkMontant();
            } else {
                soldeInfo.style.display = 'none';
                currentSolde = 0;
                currentDecouvert = 0;
            }
        }

        function checkMontant() {
            const montant = parseFloat(document.getElementById('montant').value) || 0;
            const maxDisponible = currentSolde + currentDecouvert;
            const montantWarning = document.getElementById('montantWarning');
            
            if (montant > 0 && montant > maxDisponible) {
                document.getElementById('warningText').textContent = 
                    `Le montant dépasse les fonds disponibles (${maxDisponible.toLocaleString('fr-FR')} XOF)`;
                montantWarning.style.display = 'block';
            } else {
                montantWarning.style.display = 'none';
            }
        }

        // Validation côté client
        document.getElementById('montant').addEventListener('input', function(e) {
            const value = parseFloat(e.target.value);
            if (value > 5000000) {
                e.target.setCustomValidity('Le montant ne peut pas dépasser 5,000,000 XOF');
            } else if (value <= 0) {
                e.target.setCustomValidity('Le montant doit être positif');
            } else {
                e.target.setCustomValidity('');
            }
            
            checkMontant();
        });

        document.querySelector('.admin-form').addEventListener('submit', function(e) {
            const compteId = document.getElementById('compteId').value;
            const montant = parseFloat(document.getElementById('montant').value || 0);
            
            if (!compteId) {
                alert('Veuillez sélectionner un compte');
                e.preventDefault();
                return false;
            }
            
            if (montant <= 0) {
                alert('Le montant doit être positif');
                e.preventDefault();
                return false;
            }
            
            if (montant > 5000000) {
                alert('Le montant ne peut pas dépasser 5,000,000 XOF');
                e.preventDefault();
                return false;
            }
            
            const maxDisponible = currentSolde + currentDecouvert;
            if (montant > maxDisponible) {
                alert(`Fonds insuffisants. Disponible: ${maxDisponible.toLocaleString('fr-FR')} XOF`);
                e.preventDefault();
                return false;
            }
            
            // Confirmation
            if (!confirm(`Confirmer le retrait de ${montant.toLocaleString('fr-FR')} XOF ?`)) {
                e.preventDefault();
                return false;
            }
        });

        // Dropdown menu
        document.querySelector('.dropdown-toggle').addEventListener('click', function(e) {
            e.preventDefault();
            const dropdown = this.parentElement;
            dropdown.classList.toggle('show');
        });

        // Fermer dropdown si clic à l'extérieur
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html>
        </div>
    </div>
</section>
</body>
</html>